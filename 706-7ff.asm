L0000   = $0000    \ ZPG address of EOR table ($600)

L0002   = $0002    \ ZPG address of memory to decrypt ($1400)
L0003   = $0003    \ "

L0005   = $0005    \ High byte of max memory address to decrypt ($30/$3000)

L0006   = $0006    \ final jump address to begin game execution

L000A   = $000A    \ Stores a copy of the
L000B   = $000B    \ vector table address

L005C   = $005C    \ Set to 1 before jump to game
L005D   = $005D    \ Set to 1 before jump to game
L005E   = $005E    \ Set to 1 before jump to game
L005F   = $005F    \ Set to 1 before jump to game
L0065   = $0065    \ Set to 0 at start

USERV   = $0200    \ USERV
L020E   = $020E    \ WRCHV LO
L020F   = $020F    \ WRCHV HI
L0220   = $0220    \ EVENTV LO
L0221   = $0221    \ EVENTV HI

L3527   = $3527    \ These are where the original
L3528   = $3528    \ vector values are stored by
L3529   = $3529    \ the loading routine before they
L352A   = $352A    \ are changed for the music player

L79C1   = $79C1    \ Address of subroutine in 'STRIKE'

S_ULA   = $FE10    \ Serial ULA
LFFB6   = $FFB6    \ Length of vector table
LFFB7   = $FFB7    \ Vector table low byte
LFFB8   = $FFB8    \ Vector table high byte
osbyte  = $FFF4

        org     $0706
.BeebDisStartAddr
        LDY     #$00
        STY     L0065
        CLI
		
.L070B  \ Write first 8 ZPG values?
        JSR     L79C1

        STA     L0000,Y
        INY
        CPY     #$08
        BNE     L070B

        SEI
		
		\ Restore WRCH vectors
        LDA     L3527
        STA     L020E
        LDA     L3528
        STA     L020F
		\ Restore EVNT vectors
        LDA     L3529
        STA     L0220
        LDA     L352A
        STA     L0221
		
        CLI
		
		\ Disable output buffer empty event
        LDA     #$0D
        LDX     #$00
        JSR     osbyte

        \ Disable ESCAPE pressed event
        LDA     #$0D
        LDX     #$06
        JSR     osbyte

        \ Flush all buffers
        LDA     #$0F
        LDX     #$00
        JSR     osbyte

        \ Get OS version
        LDA     #$00
        LDX     #$01
        LDY     #$00
        JSR     osbyte

        CPX     #$01    \ OS1.2?
        BNE     L076B

        \ Do OS 1.20 things
        SEI
        LDA     LFFB7   \ copy vector table
        STA     L000A   \ low byte
        LDA     LFFB8   \ copy vector table
        STA     L000B   \ high byte
        LDY     #$00
		
.L075F
        LDA     (L000A),Y  \ Get vector table?
        STA     USERV,Y
        INY
        CPY     LFFB6
        BNE     L075F      \ loop around

        CLI
		
.L076B
        LDA     #$C8
        LDX     #$03
        LDY     #$00
        JSR     osbyte     \ R/W Econet read chr interception status

        LDA     #$7C
        JSR     osbyte     \ clear ESCAPE condition

        SEI
        LDY     #$00
		
.decrypt_L077C
        \ The decryption table gets built at $600 and used to EOR the memory
		\ from $1E00 to $2FFF.
		\ Decryption table is $600 to $6FF (255 bytes) and gets reused for each page.
		
        LDA     (L0000),Y     \ ($00),Y
        EOR     (L0002),Y     \ ($1400),Y
        STA     (L0002),Y     \ ($1400),Y
        INY
        BNE     decrypt_L077C \ do for 255 bytes

        INC     L0003         \ increment high byte of decryption table address
        LDA     L0003
        CMP     L0005         \ compare with max address to decrypt (high byte)
        BNE     decrypt_L077C \ loop

        LDA     #$40
        STA     S_ULA
        LDA     #$01
        STA     L005C
        STA     L005D
        STA     L005E
        STA     L005F
        CLI
        JMP     (L0006)

\ Data below appears to be unused. Memory is written up to &7B0.
\ No reads observed from &79D-&7B0

        EQUB    $97,$E1,$9E,$F8,$C8,$C0,$B9,$3C	
        EQUB    $7B,$FC,$C1,$5A,$C5,$73,$F7,$55
        EQUB    $AB,$9B,$94,$82,$70,$6D,$54,$03
        EQUB    $8C,$4F,$4A,$07,$10,$83,$98,$91
        EQUB    $49,$E5,$17,$CA,$54,$5D,$54,$3C
        EQUB    $4C,$18,$AF,$C2,$D5,$8C,$3C,$F1
        EQUB    $5B,$28,$0D,$06,$CB,$95,$7C,$99
        EQUB    $51,$D0,$1B,$73,$4E,$19,$2D,$56
        EQUB    $44,$C3,$DE,$E7,$92,$7C,$50,$51
        EQUB    $F1,$DE,$6C,$37,$93,$06,$91,$4A
        EQUB    $BC,$44,$05,$59,$41,$0A,$4C,$9C
        EQUB    $09,$2B,$81,$4C,$83,$8F,$72,$00
        EQUB    $00,$00,$00,$77,$00,$00,$00,$00
        EQUB    $C0,$C0,$C0,$C0,$04,$04,$04,$04
        EQUB    $00,$00,$00,$64,$00,$00,$00,$FF
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$05,$00,$00,$00,$FF
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$64,$00,$00,$00,$00
        EQUB    $FF,$00,$00,$00,$00,$EF,$00,$0D
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $64,$06,$90,$64,$06,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$90
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $FF,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $FF,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $10,$10,$10,$10,$10,$10,$10,$10
        EQUB    $FF,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $40,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$7B,$95,$0D,$07,$90,$0D
        EQUB    $C1,$90,$0D,$AA,$91,$0D,$D0,$95
        EQUB    $0D,$93,$8E,$0D,$AA,$95,$0D,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$17,$00,$00
        EQUB    $FF,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00
        EQUB    $00,$00,$00,$00,$00,$00,$00,$00

        EQUB    $FF,$00,$00,$00,$00

.BeebDisEndAddr
SAVE "706-709.bin",BeebDisStartAddr,BeebDisEndAddr

